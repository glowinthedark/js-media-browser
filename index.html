<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="author" content="info@xhumanoid.com">
    <title>Media Browser</title>
    <link rel="stylesheet" href="css/split-pane.css" />
    <link rel="stylesheet" href="css/pretty-split-pane.css" />
    <script src="js/jquery-3.6.3.min.js"></script>
    <script src="js/angular.min.js"></script>
    <script src="js/split-pane.js"></script>
    <script src="js/angular-split-pane.js"></script>
    <script src="js/marked-4.2.12.min.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="ico/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="ico/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="ico/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="ico/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="ico/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="ico/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="ico/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="ico/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="ico/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="ico/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="ico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="ico/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="ico/favicon-16x16.png">
    <link rel="stylesheet" href="css/highlight-11.7.0.min.css">
    <link rel="manifest" href="ico/manifest.json" crossorigin="use-credentials">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="ico/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <style type="text/css">
        html,
        body {
            height: 100%;
            min-height: 100%;
            margin: 0;
            padding: 0;
        }

        p {
            padding: 0;
            margin: 0;
        }

        .media-pane {
            position: relative;
        }

        #playbackSpeed {
            max-width: 30px;
            min-width: 30px;
            position: absolute;
            top: 0;
            right: 0;
            z-index: 1000;
        }

        audio {
            min-width: 90%;
            max-width: 90%;
            width: 90%;
            display: block;
            margin: 0 40px 0 0;
        }

        video {
            height: 100%;
            min-height: 100%;
            max-width: 100%;
            display: block;
            margin: 0 auto;
            text-align: center;
        }

        iframe {
            background-color: white;
        }

        #docview {
            border-style: none;
            margin: 0;
            padding: 0
        }

        a:link {
            color: #808080;
            text-decoration: none;
        }

        /* visited link */

        a:visited {
            color: #808080;
            text-decoration: none;
        }

        /* mouse over link */

        a:hover {
            color: #ff7d12;
        }

        /* selected link */

        a:active {
            color: #ff7d12;
        }

        * {
            padding: 0;
            margin: 0;
        }

        li {
            list-style: none;
            padding: 0 .1em .1em .7em;
            margin: 0;
        }

        .spinhost {
            position: relative;
        }

        .spinhost #spinr_content {
            display: none;
        }

        .fileinfo {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            align-items: baseline;
            flex-wrap: nowrap;
            flex-direction: row;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            white-space: nowrap;
            overflow: hidden;
        }

        .size {
            color: gray;
            font-size: 90%;
            font-stretch: ultra-condensed;
            flex-shrink: 0;
            white-space: nowrap;
            overflow: hidden;
        }

        .fname {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        nav {
            white-space: nowrap;
            overflow: hidden;
        }

        .inlined {
            display: table-cell;
            margin: 0;
            padding: 0;
        }

        .inlined a {
            display: inline-block;
            width: 100%;
        }

        .btn-back {
            background-color: white;
            font-size: 140%;
            width: 70%;
            cursor: pointer;
            float: left;
            border-bottom: 1px solid #fafafa;
            padding-left: 5px;
        }

        .m3u {
            padding-right: 5px;
            min-width: 16%;
            float: right;
            text-align: right;
        }

        .m3u a {
            font-size: 10px;
        }

        .split-pane .lk-no-ovrflw {
            background-color: white;
            overflow: hidden !important;
        }

        .pretty-split-pane-component-inner {
            padding: 0;
        }

        select {
            background: transparent;
            font-size: 16px;
            border: 0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            color: lightgray;
        }

        * {
            font-family: "Droid Sans", sans-serif;
            font-size: 12pt;
            line-height: 160%;
            padding: 0;
            margin: 0;
        }

        /* http://jsfiddle.net/xLc2Le0k/15/
        */

        a.imglnk {
            display: flex;
            justify-content: space-around;
        }

        .preview img {
            width: 100%;
            min-width: 50px;
        }

        @media (min-width: 768px) {
            .preview img {
                max-width: 300px;
            }
        }

        @media only screen and (max-width: 767px) {
            body {
                padding: 0;
                margin: 0;
            }

            * {
                font-family: "Droid Sans", sans-serif;
                font-size: 14pt;
                line-height: 160%;
                padding: 0;
                margin: 0;
            }

            .preview img {
                max-width: 400px;
            }
        }

        /* SPINNER */

        .ispinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            z-index: 99999;
        }

        .ispinner .ispinner-blade {
            position: absolute;
            top: 6.5px;
            left: 8.5px;
            width: 2.5px;
            height: 6.5px;
            background-color: #8e8e93;
            border-radius: 1.25px;
            animation: iSpinnerBlade 1s linear infinite;
            will-change: opacity;
        }

        .ispinner .ispinner-blade:nth-child(1) {
            transform: rotate(45deg) translateY(-6.5px);
            animation-delay: -1.625s;
        }

        .ispinner .ispinner-blade:nth-child(2) {
            transform: rotate(90deg) translateY(-6.5px);
            animation-delay: -1.5s;
        }

        .ispinner .ispinner-blade:nth-child(3) {
            transform: rotate(135deg) translateY(-6.5px);
            animation-delay: -1.375s;
        }

        .ispinner .ispinner-blade:nth-child(4) {
            transform: rotate(180deg) translateY(-6.5px);
            animation-delay: -1.25s;
        }

        .ispinner .ispinner-blade:nth-child(5) {
            transform: rotate(225deg) translateY(-6.5px);
            animation-delay: -1.125s;
        }

        .ispinner .ispinner-blade:nth-child(6) {
            transform: rotate(270deg) translateY(-6.5px);
            animation-delay: -1s;
        }

        .ispinner .ispinner-blade:nth-child(7) {
            transform: rotate(315deg) translateY(-6.5px);
            animation-delay: -0.875s;
        }

        .ispinner .ispinner-blade:nth-child(8) {
            transform: rotate(360deg) translateY(-6.5px);
            animation-delay: -0.75s;
        }

        .ispinner.ispinner-large {
            width: 35px;
            height: 35px;
        }

        .ispinner.ispinner-large .ispinner-blade {
            top: 11.5px;
            left: 15px;
            width: 5px;
            height: 12px;
            border-radius: 2.5px;
        }

        .ispinner.ispinner-large .ispinner-blade:nth-child(1) {
            transform: rotate(45deg) translateY(-11.5px);
        }

        .ispinner.ispinner-large .ispinner-blade:nth-child(2) {
            transform: rotate(90deg) translateY(-11.5px);
        }

        .ispinner.ispinner-large .ispinner-blade:nth-child(3) {
            transform: rotate(135deg) translateY(-11.5px);
        }

        .ispinner.ispinner-large .ispinner-blade:nth-child(4) {
            transform: rotate(180deg) translateY(-11.5px);
        }

        .ispinner.ispinner-large .ispinner-blade:nth-child(5) {
            transform: rotate(225deg) translateY(-11.5px);
        }

        .ispinner.ispinner-large .ispinner-blade:nth-child(6) {
            transform: rotate(270deg) translateY(-11.5px);
        }

        .ispinner.ispinner-large .ispinner-blade:nth-child(7) {
            transform: rotate(315deg) translateY(-11.5px);
        }

        .ispinner.ispinner-large .ispinner-blade:nth-child(8) {
            transform: rotate(360deg) translateY(-11.5px);
        }

        @keyframes iSpinnerBlade {
            0% {
                opacity: 0.85;
            }

            50% {
                opacity: 0.25;
            }

            100% {
                opacity: 0.25;
            }
        }

        .hidden {
            display: none;
        }

        /* webvtt */
        video::cue {
            color: #ffc800;
            border: 3px solid black;
            text-align: center;
        }

        video::cue(b) {
            color: rgb(51, 216, 18);
            border: 3px solid black;
        }

        video::cue(i) {
            color: #00bafd;
            border: 3px solid black;
        }

        video::cue(u) {
            text-decoration: none;
            color: #ff00ee;
            border: 3px solid black;
        }

        video::cue(.w) {
            color: white;
        }

        video::cue(.b) {
            color: aqua;
        }

        video::cue(.p) {
            color: rgb(255, 0, 255);
        }
    </style>
    <script>
    var IS_HIGHLIGHTER_ENABLED = true;
    const IS_ALWAYS_USE_PDF_JS = false;
    const USER_INDEX_JSON = 'index.json';
    const _MB_CURR_VTT = 'mb_last_vtt';
    const _MB_SHOW_HIDDEN = 'mb_show_hidden';
    const _MB_SKIP_START = 'mb_skip_start';
    const _MB_PDF_JS = 'mb_use_pdfjs';
    const _MB_NOHL = 'mb_hohl';
    const _MB_FILTER = 'mb_filter';

    const REGEX_TYPE_AUDIO = /\.(mp3|m4a|aac|flac|ape|wav|ogg|oga)$/i;
    const REGEX_TYPE_VIDEO = /\.(mp4|m4v|avi|mov|mpg|mpeg|webm|ogv|ogm|opus|mkv)/i;
    const REGEX_TYPE_AUDIO_VIDEO = /(mp3|m4a|aac|flac|ape|wav|ogg|oga|ogv|mp4|m4v|avi|mov|mpg|mpeg|webm|mkv)$/i;
    const REGEX_TYPE_IMAGE = /\.(gif|jpe?g|a?png|tiff?|bmp|eps|pcx|webp|ico|psd|xpm|wmf|svg|heic)$/i;
    const REGEX_TYPE_CONTENT = /\.(pdf|html?|php|asp|js|py|sh|xml|txt|bat|docx?|xlsx?|s?css|java|c|log|\..+rc|cpp|h|hpp|srt|vtt|cfg|conf|ini|gif|jpe?g|a?png|tiff?|bmp|eps|pcx|webp|ico|psd|xpm|wmf|svg|cs|pl)$/i;
    const REGEX_TYPE_CODE = /\.(kt|go|ics|rst?|rb|dart|php|js|tsx?|py|z?sh|xml|plist|bat|css|json|java|c|cpp|h|m|hpp|conf|ini|pl|yaml|yml|groovy|swift|properties|gradle|srt|sql|lua|m3u8?)$/i;
    const REGEX_TYPE_MARKDOWN = /\.(md)$/i;

    const ICON_AUDIO = "&#x1F3A7;" // 🎧
    const ICON_VIDEO = "&#x1F3A5;" // 🎥
    const ICON_PDF = "&#128195;" // 📃
    const ICON_DIR = "&#128193;" // 📁
    const ICON_HTML = "&#x1F30D;" // 🌍
    const ICON_IMAGE = "&#x1F305;" // 🌅
    const ICON_UNKNOWN = "&#x2753;" // ❓
    const ICON_BACK = "&#x21B0;" // ↰
    const ICON_TEXT = "&#x1F4C3;" // 📃
    const ICON_MISC = "&#x1F9E9;" // 🧩
    const ICON_MARKDOWN = "&#x1F17C;" // 🅼

    const ICONS_BY_TYPE = {
        'pdf': ICON_PDF,

        'aac': ICON_AUDIO,
        'ape': ICON_AUDIO,
        'flac': ICON_AUDIO,
        'm4a': ICON_AUDIO,
        'mp3': ICON_AUDIO,
        'oga': ICON_AUDIO,
        'ogg': ICON_AUDIO,
        'wav': ICON_AUDIO,

        '3gp': ICON_VIDEO,
        '3gpp': ICON_VIDEO,
        'm4v': ICON_VIDEO,
        'mkv': ICON_VIDEO,
        'mov': ICON_VIDEO,
        'mp4': ICON_VIDEO,
        'ogm': ICON_VIDEO,
        'ogv': ICON_VIDEO,
        'opus': ICON_VIDEO,
        'vob': ICON_VIDEO,
        'webm': ICON_VIDEO,

        'asp': ICON_HTML,
        'htm': ICON_HTML,
        'html': ICON_HTML,
        'mhtm': ICON_HTML,
        'php': ICON_HTML,

        'bmp': ICON_IMAGE,
        'gif': ICON_IMAGE,
        'heic': ICON_IMAGE,
        'jpeg': ICON_IMAGE,
        'jpg': ICON_IMAGE,
        'png': ICON_IMAGE,
        'svg': ICON_IMAGE,
        'webp': ICON_IMAGE,

        'md': ICON_MARKDOWN,

        'cfg': ICON_TEXT,
        'ics': ICON_TEXT,
        'ini': ICON_TEXT,
        'log': ICON_TEXT,
        'rst': ICON_TEXT,
        'srt': ICON_TEXT,
        'txt': ICON_TEXT,
        'vtt': ICON_TEXT,

        'bat': ICON_MISC,
        'c': ICON_MISC,
        'conf': ICON_MISC,
        'cpp': ICON_MISC,
        'cs': ICON_MISC,
        'css': ICON_MISC,
        'dart': ICON_MISC,
        'go': ICON_MISC,
        'gradle': ICON_MISC,
        'groovy': ICON_MISC,
        'h': ICON_MISC,
        'hpp': ICON_MISC,
        'java': ICON_MISC,
        'js': ICON_MISC,
        'json': ICON_MISC,
        'kt': ICON_MISC,
        'lua': ICON_MISC,
        'm': ICON_MISC,
        'm3u': ICON_MISC,
        'm3u8': ICON_MISC,
        'pl': ICON_MISC,
        'plist': ICON_MISC,
        'properties': ICON_MISC,
        'py': ICON_MISC,
        'rb': ICON_MISC,
        'rs': ICON_MISC,
        'scss': ICON_MISC,
        'sh': ICON_MISC,
        'sql': ICON_MISC,
        'swift': ICON_MISC,
        'ts': ICON_MISC,
        'tsx': ICON_MISC,
        'xml': ICON_MISC,
        'yaml': ICON_MISC,
        'yml': ICON_MISC,
        'zsh': ICON_MISC,
    }

    AUTO_PLAY_NEXT = true;

    const URL_TRANSFORMATIONS = [
        // LINK REGEX                                        MATCHING LINK REPLACEMENT
        [/clo_(\d{3}).*\.mp3/i, "../PDF/CLO_$1_Vocab.pdf"],
        // chinesepod content links (pdf, html)
        [/(.*chinesepod.*?)(?:_ex)?\.(pdf|html?)/i, "../$1pr.aac"],
        // chinesepod media links (aac, mp3..)
        [/(.*chinesepod.*?)(?:(dg|pr|rv))?\.(aac|mp3|m4a)/i, "pdf/$1.pdf"],

        // chinese pod collection
        [/(.*?)pr+([^.]+)\.mp3/i, "$1$2.pdf"],
        [/([^\s,-]+)\b([^.]+)\.(pdf)/i, "$1pr$2.mp3"]
        // [/(.*).pdf/i,                     function (match, capture) {
        //     return match.replace(/-/g, ' ') + ' ';
        // }]
    ];

    const SKIP_INTROS = [
        [/rv\./i, 5],
        [/dg\./i, 4],
        [/pr\./i, 10],
        [/whale/i, 20]
    ];

    // Opera 8.0+
    var isOpera = (!!window.opr && !!opr.addons) || !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;

    // Firefox 1.0+
    var isFirefox = typeof InstallTrigger !== 'undefined';

    // Safari 3.0+ "[object HTMLElementConstructor]"
    var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) {
        return p.toString() === "[object SafariRemoteNotification]";
    })(!window['safari'] || (typeof safari !== 'undefined' && window['safari'].pushNotification));

    // Internet Explorer 6-11
    var isIE = /*@cc_on!@*/ !!document.documentMode;

    // Edge 20+
    var isEdge = !isIE && !!window.StyleMedia;

    // Chrome 1 - 79
    var isChrome = (/Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor)) || (!!window.chrome && (!!window.chrome.webstore || !!window.chrome.runtime));

    // Edge (based on chromium) detection
    var isEdgeChromium = isChrome && (navigator.userAgent.indexOf("Edg") !== -1);

    // Blink engine detection
    var isBlink = (isChrome || isOpera) && !!window.CSS;

    var isMobile = window.orientation > -1;

    var HEIGHT_AUDIO = 50;

    if (isChrome) {
        HEIGHT_AUDIO = 50;
    } else if (isOpera) {
        HEIGHT_AUDIO = 54;
    } else if (isFirefox) {
        HEIGHT_AUDIO = 40;
    }
    const HEIGHT_VIDEO = 500;

    function playNext(e) {
        var href = window.lastClicked.attr('href');

        if (AUTO_PLAY_NEXT && href && isPlayableLink(href)) {
            var nextLink = window.lastClicked;
            do {
                nextLink = nextLink.closest('li').next('li').find('a');
            } while (nextLink.length !== 0 && !isPlayableLink(nextLink.attr('href')));

            if (nextLink && isPlayableLink(nextLink.attr('href'))) {
                nextLink.click();
            }
        }
    }

    function isPlayableLink(href) {
        return REGEX_TYPE_AUDIO.test(href) || REGEX_TYPE_VIDEO.test(href);
    }

    function findMatchingFileByExtension(path, extension_regex, isReturnMultiple) {

        var pathUnescaped = decodeURIComponent(path),
            baseName, parentDir;

        if (pathUnescaped.indexOf('/') !== -1) {

            baseName = pathUnescaped.split('/').pop();
            parentDir = pathUnescaped.replace(baseName, '');
        } else {
            baseName = pathUnescaped;
            parentDir = '';
        }


        // handle special cases
        for (var i = 0, len = URL_TRANSFORMATIONS.length; i < len; i++) {
            var item = URL_TRANSFORMATIONS[i];

            var matcher = item[0].exec(path);

            if (matcher) {
                return parentDir + baseName.replace(item[0], item[1]);
            }
        }

        // special case for mandarin-corner
        if (/.*mandarin-corner.*/.test(document.location.href)) {
            path = path.replace(/-/g, '%20');
        }

        // remove extension
        var base_path = path.substring(0, path.lastIndexOf('.'));

        // search for links fuzzy matching given URL
        var matched = $("[href*='" + base_path + "' i]");

        var media_entries = matched.filter(
            function () {
                return extension_regex.test(this);
            }
        );

        if (media_entries.length) {
            if (isReturnMultiple) {
                return media_entries.filter(function () {
                    return this.href;
                });
            } else {
                return media_entries[0].href || media_entries[0];
            }
        }
    }

    function isValidUrl(url) {
        var isOk = false;
        $.ajax({
            type: "HEAD",
            async: false,
            cache: false,
            url: url
        }).done(function (message, text, jqXHR) {
            isOk = true;
        }).fail(function () {
            console.log(`ERROR:HEAD: ${url}`);
        });

        return isOk;
    }
    function fullscreenOn(p) {
        var fs = p.requestFullscreen || p.webkitRequestFullscreen || p.mozRequestFullScreen || p.oRequestFullscreen || p.msRequestFullscreen;
        fs.call(p);
    }

    function fullscreenOff(p) {
        var fsx = p.exitFullScreen || p.webkitExitFullScreen || p.mozExitFullScreen || p.oExitFullScreen || p.msExitFullScreen;
        fsx.call(p);
    }

    function attachEventListeners() {

        window.audioplayer = $('#audioplayer');
        window.videoplayer = $('#videoplayer');
        var contentPanel = $('#docview');

        // video play/pause on click (firefox and safari already do this OOTB)
        if (!window.safari && !window.netscape) {
            videoplayer.click(function (e) {
                this.paused ? this.play() : this.pause();
                e.preventDefault();
                e.stopImmediatePropagation();
            });
        }
        /*
        */
        // AUTOSKIP INTRO
        $('#audioplayer, #videoplayer').on('play', function (e) {
            if (e.target.src && e.target.currentTime === 0) {
                if (window._skipIntroGlobalSecs) {
                    e.target.currentTime = window._skipIntroGlobalSecs;
                } else {
                    for (var i = 0; i < SKIP_INTROS.length; i++) {
                        var regEx = SKIP_INTROS[i][0];
                        var skipSeconds = SKIP_INTROS[i][1];

                        if (regEx.test(decodeURIComponent(e.target.src)))
                            e.target.currentTime = skipSeconds;
                    }
                }
            }
        });

        // handle key navigation
        document.onkeydown = function (e) {
            e.preventDefault();
            e.stopImmediatePropagation();
            var p = (audioplayer.is(':visible') ? audioplayer : videoplayer).get(0);

            switch (e.which) {
                case 37: // left
                    p.currentTime = p.currentTime - 5;
                    break;
                case 38: // up
                    p.currentTime = p.currentTime + 60;
                    break;
                case 39: //  right
                    p.currentTime = p.currentTime + 5;
                    break;
                case 40: // down
                    p.currentTime = p.currentTime - 60;
                    break;
                case 32: // space
                    // chrome OOTB handles play/pause on space when the element is focused
                    if (!window.chrome || document.activeElement !== p) {
                        p.paused ? p.play() : p.pause();
                    }
                    break;
                case 70: // f-key
                    if (!(e.shiftKey || e.ctrlKey || e.altKey || e.metaKey)) {
                        if (!window.isFs) {
                            window.isFs = true;
                            fullscreenOn(p);
                        } else {
                            window.isFs = false;
                            fullscreenOff(p);
                        }
                    }
                    break;
            }
        };

        // href clicks
        $('a.fileinfo, a.imglnk, a.imglnk .preview img').click(function (e) {
            e.preventDefault();
            e.stopImmediatePropagation();
            var $link;

            if (e.target.tagName !== 'A') {
                $link = $(e.target).closest('a');
                if ($link.data('type') === 'file') {

                }
            } else {
                $link = $(e.target);
            }

            // store the link for playNext()
            window.lastClicked = $link;

            $link.css({
                'color': '',
                'font-style': ''
            });

            var path = $link
                .css({
                    'color': '#ff7d12',
                    'font-weight': 'bold'
                })
                .attr('href');

            if ($link.data('type') === 'file') {
                document.title = path;
            } else {
                // it's a folder; navigate
                var goToDir = $link.attr("href").split('#')[1];
                document.title = decodeURIComponent(goToDir);
                loadData(goToDir);
                return false;
            }
            var mediaLink;
            var contentLink; // PDF or any other text file to be loaded into the frame
            var isMediaLinkClick;

            var isAudioDefined = false;
            var isVideoDefined = false;
            var inferredMediaLink;
            var inferredContentLink;

            if (path.match(REGEX_TYPE_CONTENT)) {
                e.preventDefault();
                contentLink = path;

                var matched_file = findMatchingFileByExtension(path, REGEX_TYPE_AUDIO_VIDEO);

                if (matched_file) {
                    inferredMediaLink = matched_file;

                    if (inferredMediaLink.match(REGEX_TYPE_AUDIO)) {
                        isAudioDefined = true;
                    } else if (inferredMediaLink.match(REGEX_TYPE_VIDEO)) {
                        isVideoDefined = true;
                    }
                }
            } else if (path.match(REGEX_TYPE_AUDIO)) {
                isMediaLinkClick = true;
                mediaLink = path;
                isAudioDefined = true;
                e.preventDefault();
            } else if (path.match(REGEX_TYPE_VIDEO)) {
                mediaLink = path;
                isMediaLinkClick = true;
                isVideoDefined = true;
                e.preventDefault();
            }

            if (!mediaLink && inferredMediaLink && isValidUrl(inferredMediaLink)) {
                mediaLink = inferredMediaLink;
            }

            // when audio or Video file is clicked then try to find the corresponding content file
            if (isMediaLinkClick) {
                var partial_path = path
                    .replace('_video', '')
                    .replace('_review', '')
                    .replace('_dialog', '');

                matched_file = findMatchingFileByExtension(partial_path, REGEX_TYPE_CONTENT);

                if (matched_file) {
                    inferredContentLink = matched_file;
                }
            }

            if (!contentLink && inferredContentLink && isValidUrl(inferredContentLink)) {
                contentLink = inferredContentLink;
            }

            var baseFile = mediaLink && mediaLink.split(/\//g).pop();
            var _scope = angular.element($("[ng-controller]")).scope();

            if (isAudioDefined) {

                if (audioplayer.attr('src') !== mediaLink) {

                    if (videoplayer.attr('src')) {
                        videoplayer.attr('src', '');
                    }
                    videoplayer.hide();
                    audioplayer
                        .attr('src', mediaLink)
                        .attr('title', decodeURIComponent(mediaLink))
                        .show();
                }
            } else if (isVideoDefined) {
                if (audioplayer.attr('src')) {
                    audioplayer.attr('src', '');
                }
                audioplayer.hide();

                if (mediaLink && videoplayer.attr('src') !== mediaLink) {
                    videoplayer.attr('title', decodeURIComponent(baseFile))
                        .attr('src', mediaLink)
                        .show();

                    // ADD VTT SUBS
                    var vttLinks = findMatchingFileByExtension(mediaLink, /.*\.vtt/, true);

                    if (vttLinks) {
                        addSubtitleTracks(vttLinks, $link);
                    } else {
                        videoplayer.empty();
                    }
                    if (mediaLink.match(/\.mkv$/i)) {
                        // *TRY* to play matroska (only chrome and not properly supported)
                        videoplayer.attr('type', `type='video/x-matroska; codecs="theora, vorbis"'`);
                    } else if (videoplayer.attr('type')) {
                        videoplayer.attr('type', '');
                    }
                }
            }

            if (!mediaLink && !contentLink) {
                contentLink = path;
            }

            document.title = decodeURIComponent(path);

            if (mediaLink || !videoplayer.get(0).paused || !audioplayer.get(0).paused) {
                if (isAudioDefined || !audioplayer.get(0).paused) {
                    _scope.setFirstComponent(HEIGHT_AUDIO);
                } else if (isVideoDefined || !videoplayer.get(0).paused) {
                    _scope.setFirstComponent(contentLink ? HEIGHT_VIDEO : document.body.clientHeight);
                }
            } else if (contentLink) {
                _scope.setFirstComponent(0);
            } else if (!contentLink) {
                // why is this here?
                _scope.setLastComponent(0);
            }

            audioplayer.on('error', function () {
                // audioplayer.hide();
                console.log('AUDIO ERROR', this);

                if (!isVideoDefined) {
                    _scope.setFirstComponent(0);
                    _scope.$apply();
                }
            });

            _scope.$apply();

            if (contentLink && contentPanel.attr('src') !== contentLink) {

                contentPanel.attr('src', null);

                // chrome doesn't display PDFs natively *inside iframes*, use pdf.js instead
                if (!isMobile && (IS_ALWAYS_USE_PDF_JS || window._forcePdfJs) && contentLink.match(/\.pdf/i)) {
                // if (!isMobile && (isChrome || IS_ALWAYS_USE_PDF_JS) && contentLink.match(/\.pdf/i)) {
                    contentPanel.attr('src', `js/pdfjs/web/viewer.html?file=${encodeURIComponent(contentLink)}`);

                    // SPECIAL treatment for Markdown
                } else if (contentLink.match(REGEX_TYPE_MARKDOWN) && window.marked) {
                    $('#spinr_content').show();

                    fetch(contentLink)
                        .then(resp => resp.text())
                        .then(data => {
                            var iframe_head = contentPanel.contents().find("head");

                            var path = window.parent ? parent.window.location.pathname : window.location.pathname;
                            path = path.replace(path.split('/').pop(), '');

                            if (!iframe_head.length || !iframe_head.find('#flag_markdown').length) {
                                iframe_head.empty();
                                iframe_head.append($("<link/>", {
                                    rel: "stylesheet",
                                    id: 'flag_markdown',
                                    // https://raw.githubusercontent.com/markdowncss/splendor/master/css/splendor.min.css
                                    href: `${path === '/' ? '' : path}css/Torpedo.css`, // https://github.com/ttscoff/MarkedCustomStyles/blob/master/Torpedo.css
                                    type: "text/css"
                                }));
                            }
                            return data;
                        })
                        .then(data => {
                            var markdown_content = marked.parse(data);
                            contentPanel.contents().find('body').html(markdown_content);
                            $('#spinr_content').hide();
                            contentPanel.contents().scrollTop(0);
                        });
                    // SPECIAL treatment for XML, JS, CSS, JAVA, etc
                } else if (IS_HIGHLIGHTER_ENABLED && contentLink.match(REGEX_TYPE_CODE)) {
                    $('#spinr_content').show();

                    // refresh reference
                    contentPanel.attr('src', null);

                    fetch(contentLink)
                        .then(resp => resp.text())
                        .then(data => {
                            var head = contentPanel.contents().find("head");
                            // ONLY append if not already present
                            if (!head.length || !head.find('#flag_highlight').length) {
                                head.empty();
                                var path = window.parent ? parent.window.location.pathname : window.location.pathname;
                                path = path.replace(path.split('/').pop(), '');
                                path === '/' ? '' : path;

                                head.append($("<link/>", {
                                    rel: "stylesheet",
                                    id: 'flag_highlight',
                                    href: `${path}css/atelier-estuary-light.css`,
                                    type: "text/css"
                                })).append($('<script/>', {
                                    src: `${path}js/highlight.min-11.7.0.js`
                                }));
                            }
                            return data;
                        })
                        .then(data => {
                            $(contentPanel).ready(function () {
                                var page_content = data,
                                    body = contentPanel.contents().find('body');

                                if (contentLink.match(/\.(xml|plist)$/i)) {
                                    body.html(`<pre><code id="xml__code"></code></pre>`);
                                    body.find('#xml__code').get(0).innerText = page_content;
                                } else {
                                    body.html(`<pre><code>${page_content}</code></pre>`);
                                }
                                body.append("<script>(window.hljs ? window.hljs.highlightAll() : setTimeout(window.hljs.highlightAll(), 50));</" + "script>");
                                $('#spinr_content').hide();
                                contentPanel.contents().scrollTop(0);
                            });
                        });
                } else {
                    contentPanel.contents().find("head").empty();
                    // contentPanel.attr('type', null);
                    contentPanel.attr('src', contentLink);
                }
            }
        });
    }

    /* https://stackoverflow.com/a/20463021/191246 */
    function fileSizeIEC(a, b, c, d, e) {
        return (b = Math, c = b.log, d = 1024, e = c(a) / c(d) | 0, a / b.pow(d, e)).toFixed(e ? 2 : 0) +
            ' ' + (e ? 'KMGTPEZY'[--e] + 'B' : 'b');
    }

    function goUp() {
        var curdir = getPath();

        if (curdir) {
            if (curdir.endsWith('/')) {
                curdir = curdir.slice(0, -1);
            }
            if (window.location.href.indexOf(`/${USER_INDEX_JSON}`) != -1) {
                curdir = curdir.replace(`/${USER_INDEX_JSON}`, '');
            }

            var parentDir = curdir.substring(0, curdir.lastIndexOf('/'));

            if (window.location.href.indexOf(USER_INDEX_JSON) != -1) {
                parentDir = `${parentDir}/${USER_INDEX_JSON}`;
            }
            if (parentDir) {
                window.top.location.hash = parentDir;
                document.title = decodeURIComponent(parentDir);
                loadData(parentDir);
            }

        } else {
            window.history.back();
        }
    }

    function addSubtitleTracks(vttLinks, mediaLink) {
        videoplayer.empty();
        // strip extension
        var commonPrefix = mediaLink.data('name').replace(/\.[^/.]+$/, '');
        var meta = [];
        vttLinks.each(function () {

            var trackLabel = this.dataset.name.replace(commonPrefix, '').replace('\.(vtt|mp4|m4v|ape|flac|wav|acc|mp3)', '').replace(/^[-._/=,]/, '');
            // videoplayer.append(`<track label="${trackLabel}" srclang="en" kind="subtitles" src="${this.href}"/>`);
            meta.push({ label: trackLabel, src: this.href });
        });
        videoplayer.get(0).VTT_META = meta;
    }

    function getPath() {
        var curdir = window.top.location.hash;
        if (curdir) {
            curdir = curdir.slice(1);
        }
        return curdir || '/';
    }

    function isTrue(val) {
        return ["true", "1", "yes", "on"].indexOf(val) !== -1;
    }

    function loadData(path) {
        var curdir = path || getPath();
        var params = new URL(document.location.href).searchParams;
        var includeHidden = isTrue(params.get('hidden')) || isTrue(localStorage.getItem(_MB_SHOW_HIDDEN));
        window._skipIntroGlobalSecs = params.get('skip') || localStorage.getItem(_MB_SKIP_START);
        window._forcePdfJs = isTrue(params.get('pdfjs')) || isTrue(localStorage.getItem(_MB_PDF_JS));

        // supress highliter with 'nohl=true'
        if (isTrue(params.get('nohl') || localStorage.getItem(_MB_NOHL))) {
            IS_HIGHLIGHTER_ENABLED = false;
        }

        var filter = params.get('filter') || localStorage.getItem(_MB_FILTER);

        $('#spinr').show();

        // strip json name if the listing is from a json file
        var curdirBase = curdir.replace(/[a-z]+\.json$/, '');

        // append trailing slash for paths
        if (/^\/.*[^\/]$/.test(curdirBase)) {
            curdirBase = `${curdirBase}/`;
        }

        $.getJSON(curdir)
            .done(function (data) {
                // Natural sort
                if (window.Intl && window.Intl.Collator) {
                    var naturalCollator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
                    data.sort((a, b) => {
                        (a.is_dir || a.type === 'directory') === (b.is_dir || b.type === 'directory') ? naturalCollator.compare(a.name, b.name) : (a.is_dir || a.type === 'directory') ? -1 : 1
                    });
                }

                var filelist = document.getElementById('filelist');
                $(filelist).empty(); // REMOVE previous filelist

                data.forEach(element => {
                    if (!includeHidden && element.name.charAt(0) === '.') {
                        return;
                    }
                    var isDir = element.is_dir || element.type === 'directory';

                    if (filter && !isDir && !element.is_symlink && !RegExp(filter).test(element.name)) {
                        return;
                    }
                    var _url = element.url || element.name;
                    var type, href, icon, path = _url.replace(/^\.\//, '');

                    if (isDir) {
                        type = 'dir';
                        icon = ICON_DIR;
                        if (window.location.href.indexOf(USER_INDEX_JSON) !== -1) {
                            // using static index.json with other server than caddy
                            href = `${window.location.pathname}#${curdirBase}${path}/${USER_INDEX_JSON}`;
                        } else {
                            // using caddy
                            href = `${window.location.pathname}#${curdirBase}${path}`;
                        }

                    } else {
                        type = 'file';
                        var extension = element.name.split('.').pop().toLowerCase();
                        icon = ICONS_BY_TYPE[extension] || ICON_UNKNOWN;

                        href = `${curdirBase}${path}`;
                    }

                    var li = document.createElement('li');

                    var preview = '';

                    var lastModified = element.mod_time || element.time;

                    var fileSize = isDir ? '' : fileSizeIEC(element.size);

                    if (REGEX_TYPE_IMAGE.test(href) && element.size < 1048576) {

                        preview = `<a class="imglnk" data-type="file" title="️${element.name} - [${fileSize}] &#x1F55D; ${lastModified}" href="${href}">
                                <div class="preview">
                                    <img src="${href}">
                                </div>
                            </a>`;
                    }

                    $(li).html(`${preview}\n<a class="fileinfo" data-type="${type}" data-name="${element.name}" title="${element.name} - &#x1F55D; ${lastModified}" href="${href}">
                            <span class="fname">${icon}&nbsp;${element.name}</span>
                            <span class="size">${fileSize}</span>
                        </a>`);
                    filelist.appendChild(li);
                });

            }).fail(function (jqxhr, textStatus, error) {
                var err = textStatus + ", " + error;
                alert(`${err}\n${JSON.stringify(jqxhr)}`);
                console.log("Request Failed: " + err);
            }).then(() => {
                console.log('DONE');
                attachEventListeners();
            }).always(function name(params) {
                window.top.location.hash = curdir;
                $('#spinr').hide();
            });
    }

    $(document).ready(function () {
        loadData();

        $('#docview').on('load', function (e) {
            var docHead = $(e.target).contents().find("head");
            if (e.target.src.match(REGEX_TYPE_IMAGE)) {
                docHead.append('<style type="text/css">body{height:100%; position:relative} body>img {display:block; text-align:center; position:absolute; max-width:100%; max-height:100%; margin:auto; top:0; bottom: 0; left:0; right: 0}</style>');
            }
        });

        var $videoplayer = $('#videoplayer');

        $videoplayer.on('loadedmetadata', function () {
            console.log('loadmetadata', this);

            if (this.VTT_META) {
                for (var j = 0; j < this.VTT_META.length; j++) {
                    var trk = this.VTT_META[j];
                    track = document.createElement("track");
                    track.kind = "captions";
                    track.label = trk.label;
                    track.srclang = "pi";
                    track.src = trk.src;

                    this.appendChild(track);
                }

                var lastLabel = localStorage.getItem(_MB_CURR_VTT);
                var numTracks = this.textTracks.length;

                for (var i = numTracks - 1; i >= 0; i--) {
                    var track = this.textTracks[i];
                    if (track.label === lastLabel) {
                        track.mode = "showing";
                    } else {
                        track.mode = "disabled";
                    }
                }
            }
        });

        $videoplayer.get(0).textTracks.addEventListener('change', function (e) {
            var textTrackList = this;
            var numTracks = textTrackList.length;
            var isTrackVisible = false;

            for (var i = numTracks - 1; i >= 0; i--) {
                var track = textTrackList[i];
                // https://developer.mozilla.org/en-US/docs/Web/API/TextTrack
                console.log(track.mode, track.label, track.language, track.kind, track.id);

                if (track.mode === 'showing') {
                    localStorage.setItem(_MB_CURR_VTT, track.label);
                    isTrackVisible = true;
                }
            }

            if (!isTrackVisible) {
                localStorage.removeItem(_MB_CURR_VTT);
            }
        });
    });

    function makeFile(bytesOrString, fileName) {
        return new File([bytesOrString], fileName, {
                type: "text/plain;charset=utf-8"
            }
        );
    }

    function downloadToLocalFile(filename, data) {
        window.file_saver_filename = filename;
        window.file_saver_data = data;
        if (!window.saveAs) {
            var script = document.createElement('script');
            script.src = 'js/FileSaver-1.3.8.min.js';
            // script.src = 'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js';
            document.head.appendChild(script);

            script.onload = function () {
                saveAs(makeFile(window.file_saver_data, window.file_saver_filename));
            };
        } else {
            saveAs(makeFile(window.file_saver_data, window.file_saver_filename));
        }
    }

    function downloadPlaylist(e) {
        var m3u_data = "#EXTM3U\n\n";
        var numEntries = 0;

        $("[data-type='file']").each(function () {
            if (REGEX_TYPE_AUDIO_VIDEO.test(this.href)){
                console.log(this.dataset.name);
                var url = new URL(this.href, document.location.origin).href;
                m3u_data += `#EXTINF:123,${this.dataset.name}\n${url}\n`;
                numEntries++;
            }

        });

        if (numEntries){
            var dirname = document.location.hash;
            if (dirname.endsWith('/')) {
                dirname = dirname.slice(0, -1);
            }
            var downloadName = `${dirname.substring(dirname.lastIndexOf('/')+1, dirname.length)}`;
            downloadName = decodeURIComponent(downloadName);
            var m3uFileName = `${(downloadName || 'playlist')}.m3u`;
            downloadToLocalFile(m3uFileName, m3u_data);
        } else {
            alert("No playable files found!")
        }
    }
    </script>
</head>

<body data-ng-app="mediabro" ng-controller="MainCtrl">

    <div class="pretty-split-pane-frame">

        <div data-split-pane>

            <div data-split-pane-component data-width="300px">
                <div class="pretty-split-pane-component-inner spinhost">
                    <nav>
                        <div class="inlined btn-back">
                            <a title="parent folder" href="#" onclick="goUp();return false;">&#x21B0;</a>
                        </div>
                        <div class="inlined m3u">
                            <a id="m3u-playlist" title="Download M3U playlist" target="_blank" onclick="downloadPlaylist();return false;" href="#">M3U</a>
                        </div>
                    </nav>
                    <div id="spinr" class="ispinner ispinner-large">
                        <div class="ispinner-blade"></div>
                        <div class="ispinner-blade"></div>
                        <div class="ispinner-blade"></div>
                        <div class="ispinner-blade"></div>
                        <div class="ispinner-blade"></div>
                        <div class="ispinner-blade"></div>
                        <div class="ispinner-blade"></div>
                        <div class="ispinner-blade"></div>
                    </div>
                    <div style="clear:both"></div>
                    <ul id="filelist">

                    </ul>
                </div>
            </div>

            <div data-split-pane-divider data-width="5px"></div>

            <div data-split-pane-component>

                <div data-split-pane data-split-pane-properties="splitPaneProperties">
                    <div data-split-pane-component data-height="54px">
                        <div class="pretty-split-pane-component-inner media-pane">
                            <audio onended="playNext();" style="display:none" id="audioplayer" autoplay controls>
                            </audio>
                            <video onended="playNext();" style="display:none" id="videoplayer" autoplay controls>
                            </video>
                        </div>
                    </div>
                    <div data-split-pane-divider data-height="5px"></div>
                    <div data-split-pane-component class="lk-no-ovrflw spinhost">
                        <div id="spinr_content" class="ispinner ispinner-large">
                            <div class="ispinner-blade"></div>
                            <div class="ispinner-blade"></div>
                            <div class="ispinner-blade"></div>
                            <div class="ispinner-blade"></div>
                            <div class="ispinner-blade"></div>
                            <div class="ispinner-blade"></div>
                            <div class="ispinner-blade"></div>
                            <div class="ispinner-blade"></div>
                        </div>
                        <iframe id="docview" width="100%" height="99%" frameBorder="0" cellspacing="0">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        angular.module('mediabro', ['shagstrom.angular-split-pane'])
            .controller('MainCtrl', function ($scope) {
                $scope.splitPaneProperties = {};

                $scope.setFirstComponent = function (value) {
                    $scope.splitPaneProperties.firstComponentSize = value;
                };
                $scope.setLastComponent = function (value) {
                    console.log(value);
                    $scope.splitPaneProperties.lastComponentSize = value;
                };
            });
    </script>
</body>

</html>
